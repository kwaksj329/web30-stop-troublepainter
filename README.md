<div align=center>
  <img width="1000" alt="헤더 (1)" src="https://github.com/user-attachments/assets/03d61582-d3ad-477a-8301-bce895306d8a">
</div>

<br>

<div align=center>

<p align=center>
  <a href="https://inquisitive-beret-c36.notion.site/12855cd93d4f800b91bccc3ccf9d1444?pvs=74">팀 노션</a>
  &nbsp; | &nbsp; 
  <a href="https://github.com/orgs/boostcampwm-2024/projects/212">프로젝트</a>
  &nbsp; | &nbsp;
  <a href="https://www.figma.com/design/Gl1naj84mDIWkG7IHZoVpo/%EC%9B%A8%EB%B2%A0%EB%B2%B1-UI-%EB%94%94%EC%9E%90%EC%9D%B8?node-id=71-124&t=acRqurOAstA2WU8J-1">피그마</a>
  &nbsp; | &nbsp; 
  <a href="https://github.com/boostcampwm-2024/web30-stop-troublepainter/wiki">위키</a>
  <br>
  <a href="https://www.troublepainter.site/">배포 링크</a>
  &nbsp; | &nbsp; 
  <a href="https://boostcampwm-2024.github.io/web30-stop-troublepainter/">TypeDoc</a>
  &nbsp; | &nbsp; 
  <a href="https://boostcampwm-2024.github.io/web30-stop-troublepainter/storybook-develop/?path=/docs/">Storybook</a>
</p>

</div>

## 1. 프로젝트 소개

**방해꾼은 못말려**는 실시간 멀티플레이어 그림 맞추기 게임입니다. 

플레이어들은 **그림꾼**, **방해꾼**, **구경꾼** 역할로 나뉘어 제시어를 그리고 맞추는 게임을 진행합니다.

- URL 게임방 초대
- 실시간 드로잉 동기화
- 실시간 채팅

---

## 2. 기술 선택

### 2.1 WebRTC에서 WebSocket으로의 전환

#### 초기 검토: WebRTC

실시간 드로잉 동기화를 위해 처음에는 **WebRTC**를 검토했습니다.

| WebRTC 장점 | WebRTC 한계 |
|-------------|-------------|
| UDP 기반 전송으로 지연에 민감한 실시간 통신에 유리 | Mesh 구조에서 참가자 수 증가 시 연결 수 O(n²) 로 증가 |
| P2P 구조로 중앙 서버 리소스 부담 감소 | SFU 서버 도입 시 P2P 네트워크 부하 해결은 가능하지만, 미디어 스트림 처리를 위한 추가적인 서버 자원 필요 |

#### 최종 선택: WebSocket + Socket.IO

**선택 이유:**
1. **연결 안정성**: TCP 기반으로 NAT/방화벽 환경에서도 안정적
2. **목표에 충분한 성능**: 드로잉+채팅 데이터, 충분히 실시간성 확보 가능
3. **Socket.IO를 통한 운영 편의성**: 순서 보장과 재전송, 자동 재연결 기능 등

### 2.2 테스트 라이브러리: Playwright 선택

| 라이브러리 | 장점 | 단점 |
|------------|------|------|
| **Playwright** | 다양한 브라우저, 다중 탭, 자동 대기 | 러닝 커브 |
| Cypress | 직관적 API, 좋은 DX | Safari 제한적, 다중 탭 불가 |
| Selenium | 다양한 브라우저 | 설정 복잡, WebDriver 사용으로 가장 느림 |

**선택 이유:**
1. **다중 브라우저 동시 테스트**: 실시간 멀티플레이어 게임 특성상 여러 브라우저에서 동시에 테스트 필수
2. **모바일 환경 테스트**: 모바일 환경에서도 테스트 필수

### 2.3 모노레포 + 공통 패키지(core) 분리

#### pnpm Workspace 구성

```yaml
# pnpm-workspace.yaml
packages:
  - 'core'    # 공통 타입 및 CRDT 로직
  - 'client'  # React 프론트엔드
  - 'server'  # NestJS 백엔드
```

**분리 이유:**
1. **타입 안정성**: 클라이언트-서버 간 소켓 이벤트 타입을 단일 소스에서 관리하여 타입 불일치 방지
2. **CRDT 재사용**: 동일한 CRDT 로직을 클라이언트(로컬 드로잉)와 서버(상태 병합)에서 공유
3. **독립적 빌드**: `tsup`으로 core를 ESM/CJS 듀얼 빌드하여 다양한 환경 지원

```json
// core/package.json
{
  "name": "@troublepainter/core",
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "import": "./dist/index.mjs",
      "require": "./dist/index.js"
    }
  }
}
```

---

## 3. 코드베이스 구조

### 3.1 전체 구조

- **`core/`**: 공통 타입 + CRDT 구현
- **`client/`**: 프론트엔드(Vite/React) + 캔버스 렌더링/소켓 연결
- **`server/`**: 백엔드(NestJS) + 게임 진행/소켓 브로드캐스트/Redis/AI 서비스

### 3.2 Client 폴더 구조

* 기술 역할 기반 폴더 구조

- **`components/`**: UI/기능 컴포넌트
  - `components/canvas/*`: 게임 캔버스 UI(`GameCanvas.tsx`, `CanvasUI.tsx`)
  - `components/chat/*`: 채팅 UI
  - `components/ui/*`: 버튼/드롭다운 등 재사용 UI
- **`hooks/`**: 재사용 가능한 상태/사이드이펙트 로직
  - 드로잉이나 소켓 관련 훅 모음
- **`handlers/`**: `소켓 emit` 같은 외부 I/O 호출을 한 곳에 모아, 컴포넌트/훅에서 이벤트 이름을 직접 다루지 않게 함
- **`stores/`**: 전역 상태
- **`constants/`, `utils/`, `types/`**: 상수, 유틸, 프론트 전용 타입(렌더링/컴포넌트 타입 등)
- **`pages/`, `layouts/`, `routes.tsx`**: 라우팅 단위 화면/레이아웃

---

## 4. 설계 의도

### 1) “입력/렌더링/동기화”를 서로 다른 레이어로 분리

캔버스 협업 기능은 한 파일에 몰아넣으면 유지보수가 불가능해집니다. 그래서 다음처럼 역할을 분리했습니다.

- **입력 레이어(컴포넌트)**: 포인터 이벤트를 받아 좌표를 만들고, “드로잉 시작/진행/종료”를 호출만 담당 (`client/src/components/canvas/GameCanvas.tsx`)
- **도메인 레이어(훅)**: 드로잉 상태, 잉크 계산, undo/redo, CRDT 업데이트/병합을 담당 (`client/src/hooks/canvas/useDrawing.ts`, `useDrawingState.ts`)
- **렌더링 레이어(Worker/OffscreenCanvas)**: 실제 픽셀 조작을 Worker로 위임해 UI 스레드를 보호 (`client/src/hooks/canvas/useDrawingOperation.ts`, `drawingWorker.ts`)
- **네트워크 레이어(socket store + handlers + socket hooks)**:
  - socket 연결 자체는 store가 중앙 관리 (`useSocketStore`)
  - emit은 handlers가 담당(이벤트 이름/페이로드를 한 곳에서 통제)
  - on/off 리스너 등록은 socket hook이 담당 (`useDrawingSocket`, `useGameSocket`)

### 2) CRDT를 사용한 이유와 병합 전략(LWWMap)

- 패킷 순서 뒤바뀜(out-of-order)
- 중복 수신(재전송)
- 일부 누락(일시적 연결 문제) 후 재동기화 필요

이를 단순 “마지막으로 받은 것만 그리기”로 처리하면 사용자마다 캔버스가 쉽게 달라집니다. 그래서 본 프로젝트는 **LWW(Last Write Wins) 기반 CRDT**를 사용합니다.

- **단위**: “스트로크 조각(점 2~3개)” 또는 “채우기 결과(픽셀 좌표 리스트)”를 `DrawingData`로 저장
- **저장소**: `LWWMap<DrawingData>`가 여러 레지스터를 관리
- **정렬 기준**: `createTime` 기반으로 정렬된 리스트를 유지하여 “리플레이 시 동일한 순서”를 최대한 보장 (`core/crdt/LWWMap.ts`)
- **병합 규칙**: `timestamp` 우선, 동률이면 `peerId`로 결정 (`core/crdt/LWWRegister.ts`)
- **Undo/Redo**: 실제 삭제 대신 `activated` 플래그를 토글하여 “논리적 비활성화”로 처리 (이 역시 CRDT 업데이트로 전파 가능)

### 3) “부분 렌더 vs 전체 리드로우” 구분

CRDT 병합 결과는 두 가지 케이스가 있습니다.

- **증분 적용 가능**: 방금 들어온 stroke가 기존 꼬리(tail) 뒤에 붙는다면, 캔버스에 그 stroke만 그리면 됩니다.
- **리드로우 필요**: 과거 시점에 끼어들거나(정렬 위치 변경), 활성화 상태가 바뀌거나, 더 최신 값이 과거를 덮으면 전체 순서를 다시 적용해야 합니다.

그래서 `mergeRegister/mergeMap`은 “리드로우 필요 여부”를 반환하고, 훅은 그에 따라 `operation.renderStroke` 또는 `operation.redrawCanvas`를 선택합니다. (`client/src/hooks/canvas/useDrawing.ts`)

* 서로 다른 캔버스 간 드로잉 일치율 51% 개선

https://inquisitive-beret-c36.notion.site/Playwright-6d126b266dac4607a0d5b51dc7f51312

### 4) Web Worker + OffscreenCanvas로 렌더링 최적화

특히 **채우기(flood fill)** 는 `getImageData`/`putImageData`를 동반하는 고비용 연산이며, 메인 스레드에서 실행하면 입력/애니메이션이 끊깁니다.

- 메인 스레드: 입력 이벤트 처리 + 소켓 송수신 + 상태 업데이트
- Worker: 캔버스 픽셀 연산(펜 스트로크, 채우기, 전체 리드로우)

로 분리했고, `transferControlToOffscreen()`로 캔버스 컨트롤을 Worker로 넘깁니다. (`client/src/hooks/canvas/useDrawingOperation.ts`)

* FPS 및 총 프레임 수 83~99% 개선, 60FPS에 가까운 부드러운 드로잉 환경 구현

https://inquisitive-beret-c36.notion.site/OffscreenCanvas-Web-worker-e112ef8f8d6349a6ba2b34b793d0358f?source=copy_link

---

## 5. 주요 동작 흐름

### 5.1 드로잉 동기화 전체 흐름

아래는 사용자가 화면에 그림을 그리면 다른 사용자들에게 동기화되는 전체 과정입니다.

```
┌──────────────────────────────────────────────────────────────────────────────────────────┐
│                              드로잉 동기화 전체 아키텍처                                    │
└──────────────────────────────────────────────────────────────────────────────────────────┘

[User A - 그리는 사람]                                        [User B - 보는 사람]

┌─────────────────────┐                                      ┌─────────────────────┐
│   브라우저 화면      │                                      │   브라우저 화면      │
│  ┌───────────────┐  │                                      │  ┌───────────────┐  │
│  │ Main Canvas   │  │                                      │  │ Main Canvas   │  │
│  │ (화면 표시용)  │  │                                      │  │ (화면 표시용)  │  │
│  └───────┬───────┘  │                                      │  └───────▲───────┘  │
│          │          │                                      │          │          │
│  ┌───────▼───────┐  │                                      │  ┌───────┴───────┐  │
│  │ OffscreenCanvas│ │                                      │  │ OffscreenCanvas│  │
│  │ (Web Worker)   │  │                                      │  │ (Web Worker)   │  │
│  └───────┬───────┘  │                                      │  └───────▲───────┘  │
└──────────┼──────────┘                                      └──────────┼──────────┘
           │                                                            │
     ① 포인터 이벤트                                            ⑦ 렌더링
           │                                                            │
           ▼                                                            │
┌──────────────────────┐                                    ┌───────────┴───────────┐
│     useDrawing       │                                    │    useDrawing         │
│  ┌────────────────┐  │                                    │ ┌───────────────────┐ │
│  │ LWWMap (CRDT)  │  │                                    │ │  LWWMap (CRDT)    │ │
│  │ ┌────────────┐ │  │                                    │ │ ┌───────────────┐ │ │
│  │ │ Register 1 │ │  │                                    │ │ │ Register 1    │ │ │
│  │ │ Register 2 │ │  │                                    │ │ │ Register 2    │ │ │
│  │ │    ...     │ │  │         ③ CRDT Update              │ │ │ (병합된 상태)  │ │ │
│  │ └────────────┘ │  │              Message                │ │ └───────────────┘ │ │
│  └───────┬────────┘  │                │                    │ └─────────▲─────────┘ │
└──────────┼───────────┘                │                    └───────────┼───────────┘
           │                            │                                │
     ② CRDT 메시지 생성                  │                          ⑥ CRDT 병합
           │                            │                                │
           ▼                            │                                │
┌──────────────────────┐                │                    ┌───────────┴───────────┐
│ drawingSocket.handler│                │                    │  useDrawingSocket     │
│ sendDrawing()        │                │                    │  onDrawUpdate()       │
└──────────┬───────────┘                │                    └───────────▲───────────┘
           │                            │                                │
           │ Socket.IO emit             │                                │
           ▼                            ▼                                │
═══════════════════════════════════════════════════════════════════════════════════════
           │                     WebSocket                               ▲
           │                                                             │
           ▼                                                             │
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                                   Server                                              │
│  ┌──────────────────────────────────────────────────────────────────────────────────┐│
│  │                           DrawingGateway                                          ││
│  │  @SubscribeMessage('draw')                                                        ││
│  │  handleDraw(client, data) {                                                       ││
│  │    // ④ 다른 클라이언트에게 브로드캐스트                                            ││
│  │    client.to(roomId).emit('drawUpdated', {                    ⑤ 'drawUpdated'     ││
│  │      playerId: client.data.playerId,                           emit ────────────►││
│  │      drawingData: data.drawingData                                                ││
│  │    });                                                                            ││
│  │  }                                                                                ││
│  └──────────────────────────────────────────────────────────────────────────────────┘│
│                                                                                       │
│  ┌────────────────────┐                                                              │
│  │ Redis Pub/Sub      │  ← 다중 서버 환경에서 메시지 전파                               │
│  └────────────────────┘                                                              │
└──────────────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 렌더링 최적화 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                            브라우저 렌더링 최적화                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                               Main Thread                                            │
│                                                                                      │
│  ┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐               │
│  │ React 컴포넌트    │    │ 이벤트 핸들링     │    │ 상태 업데이트     │               │
│  │ 렌더링           │    │                   │    │                   │               │
│  └────────┬─────────┘    └────────┬──────────┘    └────────┬──────────┘               │
│           │                       │                        │                          │
│           └───────────────────────┼────────────────────────┘                          │
│                                   │                                                   │
│                          postMessage()                                                │
│                                   │                                                   │
└───────────────────────────────────┼───────────────────────────────────────────────────┘
                                    │
                                    ▼
┌───────────────────────────────────────────────────────────────────────────────────────┐
│                              Web Worker Thread                                         │
│                                                                                        │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐│
│  │                         OffscreenCanvas                                            ││
│  │  ┌─────────────────────────────────────────────────────────────────────────────┐  ││
│  │  │ • 스트로크 렌더링 (drawStroke)                                               │  ││
│  │  │ • 채우기 작업 (floodFill) - CPU 집약적 작업                                   │  ││
│  │  │ • 캔버스 초기화 (clear)                                                      │  ││
│  │  │ • 전체 다시 그리기 (redraw)                                                  │  ││
│  │  └─────────────────────────────────────────────────────────────────────────────┘  ││
│  └───────────────────────────────────────────────────────────────────────────────────┘│
│                                        │                                               │
│                               자동 동기화 (transferControlToOffscreen)                  │
│                                        │                                               │
└────────────────────────────────────────┼───────────────────────────────────────────────┘
                                         │
                                         ▼
┌────────────────────────────────────────────────────────────────────────────────────────┐
│                              GPU (Compositor Thread)                                    │
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐│
│  │ Canvas Layer 합성 → 화면 출력                                                       ││
│  └─────────────────────────────────────────────────────────────────────────────────────┘│
└────────────────────────────────────────────────────────────────────────────────────────┘
```

<img width="1422" height="1746" alt="image" src="https://github.com/user-attachments/assets/85b2983f-7e43-48bc-8aec-edc341bad8b8" />


